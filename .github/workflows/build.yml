name: AetherOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # 1. Build Guests (Apps)
  build-guests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: llvm-tools-preview
    
    # Hello World (Native/Unikernel)
    - name: Install cargo-binutils
      run: cargo install cargo-binutils
    - name: Build Hello World (aarch64)
      run: |
        cd apps/hello_world
        RUSTFLAGS="-C link-arg=-T$(pwd)/layout.ld -C link-arg=-n" cargo build --release --target aarch64-unknown-none
        cd ../..
        rust-objcopy -O binary target/aarch64-unknown-none/release/hello_world apps/hello_world/guest.bin
    
    # WASM App
    - name: Add WASM Target
      run: rustup target add wasm32-unknown-unknown
    - name: Build WASM Simple
      run: cargo build --release --target wasm32-unknown-unknown -p wasm_simple

  # 2. Build AetherOS Stack - macOS
  build-aetheros-macos:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
    - name: Build AetherOS (macOS)
      run: cargo build --release -p aetheros

  # 3. Build AetherOS Stack - Linux
  build-aetheros-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Dependencies
      run: sudo apt-get update && sudo apt-get install -y libxkbcommon-dev libwayland-cursor0 libwayland-egl1 libx11-dev libxcursor-dev libxi-dev libxrandr-dev
    - name: Build AetherOS (Linux)
      run: cargo build --release -p aetheros --verbose

  # 4. Build AetherOS Stack - Windows
  build-aetheros-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build AetherOS (Windows)
      run: cargo check --release -p aetheros
