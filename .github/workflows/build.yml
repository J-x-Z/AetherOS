name: AetherOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # 1. Build Guests (Apps)
  build-guests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: llvm-tools-preview
    
    # Hello World (Native/Unikernel)
    - name: Install cargo-binutils
      run: cargo install cargo-binutils
    - name: Build Hello World (aarch64)
      run: |
        cd apps/hello_world
        RUSTFLAGS="-C link-arg=-T$(pwd)/layout.ld -C link-arg=-n" cargo build --release --target aarch64-unknown-none
        cd ../..
        rust-objcopy -O binary target/aarch64-unknown-none/release/hello_world apps/hello_world/guest-aarch64.bin
    - name: Upload Guest Artifact
      uses: actions/upload-artifact@v4
      with:
        name: guest-binary
        path: apps/hello_world/guest-aarch64.bin
    
    # WASM App
    - name: Add WASM Target
      run: rustup target add wasm32-unknown-unknown
    - name: Build WASM Simple
      run: cargo build --release --target wasm32-unknown-unknown -p wasm_simple

  # 2. Build AetherOS Stack - macOS
  build-aetheros-macos:
    runs-on: macos-14
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Download Guest
      uses: actions/download-artifact@v4
      with:
        name: guest-binary
        path: apps/hello_world
    - name: Build AetherOS (macOS)
      run: cargo build --release -p aetheros

  # 3. Build AetherOS Stack - Linux
  build-aetheros-linux:
    runs-on: ubuntu-latest
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Install Dependencies
      run: sudo apt-get update && sudo apt-get install -y libxkbcommon-dev libwayland-cursor0 libwayland-egl1 libx11-dev libxcursor-dev libxi-dev libxrandr-dev
    - name: Download Guest
      uses: actions/download-artifact@v4
      with:
        name: guest-binary
        path: apps/hello_world
    - name: Build AetherOS (Linux)
      run: cargo build --release -p aetheros --verbose

  # 4. Build AetherOS Stack - Windows
  build-aetheros-windows:
    runs-on: windows-latest
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Download Guest
      uses: actions/download-artifact@v4
      with:
        name: guest-binary
        path: apps/hello_world
    - name: Build AetherOS (Windows)
      run: cargo check --release -p aetheros

  # 5. Build AetherOS Stack - Android
  build-aetheros-android:
    runs-on: ubuntu-latest
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Add Android Target
      run: rustup target add aarch64-linux-android
    - name: Build AetherOS (Android)
      run: cargo check --target aarch64-linux-android -p aetheros

  # 6. Build AetherOS Stack - FreeBSD
  build-aetheros-freebsd:
    runs-on: ubuntu-latest
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust with FreeBSD Target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-freebsd
    - name: Check AetherOS (FreeBSD)
      run: cargo check --target x86_64-unknown-freebsd -p aetheros

  # 7. Build AetherOS Stack - NetBSD
  build-aetheros-netbsd:
    runs-on: ubuntu-latest
    needs: build-guests
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust with NetBSD Target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-netbsd
    - name: Check AetherOS (NetBSD)
      run: cargo check --target x86_64-unknown-netbsd -p aetheros


